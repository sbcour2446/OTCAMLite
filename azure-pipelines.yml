trigger:
- main

pool:
  name: 'ATEC-Data-Mesh-AgentPool-AKS'
  demands:
    - 'AGENT_SELECTOR -equals cloud.army.P'   # PROD agents required for Checkmarx reachability

variables:
  system.debug: true

steps:
# Install + select JDK 21 (needed because your project compiles with source release 21)
- bash: |
    set -euxo pipefail
    echo "Before:"
    java -version || true

    if command -v sudo >/dev/null 2>&1; then SUDO=sudo; else SUDO=""; fi
    $SUDO apt-get update
    $SUDO apt-get install -y openjdk-21-jdk ca-certificates

    echo "After install:"
    /usr/lib/jvm/java-21-openjdk-amd64/bin/java -version

    echo "##vso[task.setvariable variable=JAVA_HOME]/usr/lib/jvm/java-21-openjdk-amd64"
  displayName: "Install + select JDK 21"

# Build
- task: Gradle@2
  displayName: "Gradle build (JDK 21)"
  inputs:
    workingDirectory: ''
    gradleWrapperFile: 'gradlew'
    gradleOptions: '-Xmx3072m'
    tasks: 'build'
    publishJUnitResults: true
    testResultsFiles: '**/TEST-*.xml'
    javaHomeOption: 'Path'
    jdkDirectory: '$(JAVA_HOME)'

- task: CopyFiles@2
  displayName: 'Copy Files to: $(Build.ArtifactStagingDirectory)'
  inputs:
    SourceFolder: '$(System.DefaultWorkingDirectory)'
    Contents: '**/*.jar' # Adjust this to match your specific build outputs (e.g., '**/*.war')
    TargetFolder: '$(Build.ArtifactStagingDirectory)'

- task: PublishBuildArtifacts@1
  displayName: 'Publish Artifact: drop'
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)' # Required. Path to the folder to publish
    ArtifactName: 'drop' # Required. The name of the artifact
    publishLocation: 'Container' # Required. 'Container' (Azure Pipelines) or 'FilePath' (file share)

# Checkmarx SAST scan
- task: Application security testing@2024
  displayName: "Checkmarx SAST"
  inputs:
    sastCaChainFilePath: /etc/ssl/certs/ca-certificates.crt
    projectName: 'OTCAM Checkmarx'
    enableProxy: false
    enableSastScan: true
    CheckmarxService: 'CHECKMARX_CONNECTION_PROD'   # must exist in YOUR project
    fullTeamName: 'CxServer\OTC'
    enableSastBranching: false
    preset: 'STIG'
    generatePDFReport: true
    avoidDuplicateScans: true
    enableDependencyScan: false
    folderExclusion: ''
