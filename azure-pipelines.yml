trigger:
- main

pool:
  name: ATEC-Data-Mesh-AgentPool-AKS
  demands:
    - DEVOPS_AGENT_ENV -equals cloud.army.D

steps:
- bash: |
    set -euxo pipefail
    echo "Agent: ${AGENT_NAME}"
    java -version

    # Derive JAVA_HOME from the java binary location
    JAVA_BIN="$(readlink -f "$(command -v java)")"
    JAVA_HOME_DIR="$(dirname "$(dirname "$JAVA_BIN")")"
    echo "Detected JAVA_HOME=$JAVA_HOME_DIR"

    # Persist for later tasks
    echo "##vso[task.setvariable variable=JAVA_HOME]$JAVA_HOME_DIR"
  displayName: "Set JAVA_HOME from java"

- task: Gradle@2
  displayName: "Gradle build (use agent JDK)"
  inputs:
    workingDirectory: ''
    gradleWrapperFile: 'gradlew'
    gradleOptions: '-Xmx3072m'
    javaHomeOption: 'Path'
    jdkDirectory: '$(JAVA_HOME)'
    publishJUnitResults: true
    testResultsFiles: '**/TEST-*.xml'
    tasks: 'build'
