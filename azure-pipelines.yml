trigger:
- main

pool:
  name: ATEC-Data-Mesh-AgentPool-AKS
  demands:
    - DEVOPS_AGENT_ENV -equals cloud.army.D

steps:
- bash: |
    set -euxo pipefail
    echo "Before:"
    java -version || true

    # Install JDK 21 (requires apt access + permissions)
    if command -v sudo >/dev/null 2>&1; then SUDO=sudo; else SUDO=""; fi
    $SUDO apt-get update
    $SUDO apt-get install -y openjdk-21-jdk ca-certificates

    echo "After install:"
    /usr/lib/jvm/java-21-openjdk-amd64/bin/java -version

    # Set JAVA_HOME to JDK 21 for subsequent steps
    echo "##vso[task.setvariable variable=JAVA_HOME]/usr/lib/jvm/java-21-openjdk-amd64"
  displayName: "Install + select JDK 21"

- task: Gradle@2
  displayName: "Gradle build (JDK 21)"
  inputs:
    gradleWrapperFile: 'gradlew'
    gradleOptions: '-Xmx3072m'
    tasks: 'build'
    javaHomeOption: 'Path'
    jdkDirectory: '$(JAVA_HOME)'
    publishJUnitResults: true
    testResultsFiles: '**/TEST-*.xml'
